<!DOCTYPE html>
<html>
<head>
  <title>MNIST Digit Recognition</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis"></script>
</head>

<body>
<h2>MNIST Digit Recognition</h2>
<p>Open console for predictions.</p>

<script>
let model;

function createModel(){
  const model = tf.sequential();

  model.add(tf.layers.conv2d({
    inputShape:[28,28,1],
    filters:8,
    kernelSize:3,
    activation:'relu'
  }));

  model.add(tf.layers.maxPooling2d({poolSize:2}));
  model.add(tf.layers.flatten());
  model.add(tf.layers.dense({units:32,activation:'relu'}));
  model.add(tf.layers.dense({units:10,activation:'softmax'}));

  model.compile({
    optimizer:'adam',
    loss:'categoricalCrossentropy',
    metrics:['accuracy']
  });

  return model;
}

async function run(){
  console.log("Preparing data...");

  const xs = tf.randomNormal([500,28,28,1]);
  const labels = tf.oneHot(
    tf.randomUniform([500],0,10,'int32'),10);

  model = createModel();

  console.log("Training started...");

  await model.fit(xs, labels, {
    epochs:5,
    batchSize:64,
    callbacks: tfvis.show.fitCallbacks(
      { name: "Training Graph" },
      ['loss','acc'],
      { height: 200 }
    )
  });

  console.log("Training finished!");

  window.predictDigit = function(){
    const testImg = tf.randomNormal([1,28,28,1]);
    const pred = model.predict(testImg);
    pred.print();
  };

  console.log("Use predictDigit() in console.");
}

run();
</script>

</body>
</html>
